sap.ui.define(["sap/base/assert","sap/m/MessageToast","sap/ui/model/json/JSONModel","gramont/VCDSM/specedit/util/ModelManagerAdmin","gramont/VCDSM/specedit/util/ModelManagerChangeType","gramont/VCDSM/specedit/util/ModelManagerCollection","gramont/VCDSM/specedit/util/ModelManagerConst","gramont/VCDSM/specedit/util/ModelManagerIntStatus","gramont/VCDSM/specedit/util/ModelManagerStatus","gramont/VCDSM/specedit/util/Util"],function(e,t,r,a,o,n,s,i,l,u){"use strict";var d={NodeName:"ROOT",Key:""};var h="_ModelManager:CREATE";var v=function(e){this._oComponent=e};v.prototype.clearStorage=function(){this._oStorage={};var e=this._oStorage[d.NodeName]={};e[d.Key]={child:{},additional:null,keyRef:null,parentKeyRef:null};this._iCreateIndex=0;if(this._oAliveObj)this._oAliveObj.alive=false;this._oAliveObj={alive:true}};v.prototype.requestForBackendPassthru=function(e){var t={passthru:true,backendRequest:e};return t};v.prototype.executeFetchRequest=function(t,r,a){var o=this;var n=function(t){if(t.allSuccess){var n=t.responses;e(n.length==1,"aExecuteResponses length should be 1");var s=n[0];var i=s.response;e(i,"oResponse should be set");if(r)r(i)}else{var l=function(){if(a)a()};u.showExecuteError(o._oComponent,null,t,true,l)}};this.executeFetchRequests([t],n)};v.prototype.executeFetchRequests=function(t,r){e(t.length>0,"aRequests should contain at least one element");this._executeFetchRequestsBegin();var a={};var o=[];for(var n=0;n<t.length;n++){var s=t[n];var i=s.passthru;var l=!i?this._requestToString(s,false):"backendPassthru"+n.toString();var u=a[l];if(!u){u=a[l]={request:s,reload:false,requestIndexes:[],additional:null,fetchResponseEntries:null,storageResponseChild:null,error:null,response:null};o.push(u)}if(s.reload)u.reload=true;u.requestIndexes.push(n)}o.sort(jQuery.proxy(this._compareRequestInfo,this));var d=[];var v={};for(var n=0;n<o.length;n++){var u=o[n];var s=u.request;var c=s.nodeMetadata.name;if(!s.passthru){var f=s.nodeMetadata;var p=s.parentKey;var g=u.reload;var y=null;var _=null;var b=this._getStorageParent(f,p,true);if(b){y=this._getStorageChild(b,f);if(y){_=y.additional;e(_,"oAdditional should be set");if(c=="MultiComposition"){g=true}if(s.parentKey){if(s.parentKey.MLC==true){g=true}}if(g)y=null}}if(!_){var E;if(b){E=b.additional}else{e(f.parent.keyed,"Parent node should be keyed");var m=this._requestToString(s,true);E=v[m];if(!E){E=v[m]={parent:null}}}_={parent:E}}u.additional=_;e(u.additional,"oRequestInfo.additional should be set");if(!y){if(f.name!="Phrase"){var S=!f.parent||p[h]==null?f.backendFetchRequest(p,_):f.backendFetchEmptyRequest(p,_);var k=S.request;var C=S.response}else{var k=s;var C=null}if(k){e(!C,"oBackendResponse should be unset");d.push(k)}else{e(C,"oBackendResponse should be set");u.fetchResponseEntries=C.entries}}else{u.storageResponseChild=y}}else{var k=s.backendRequest;d.push(k)}}if(f.name!="Phrase"&&f.level==1){var R=this._getComponent().getODataManager().requestForVatlist(p);d.push(R)}var M=jQuery.proxy(this._executeFetchRequestsContinue,this,t,o,r);if(d.length>0)this._backendExecuteFetchRequests(d,M);else M(null)};v.prototype.detach=function(t){if(!t.aliveObj.alive)return;var r=t.changeListeners;var a=t.changeListener;var o=r.indexOf(a);e(o>=0,"fChangeListener should be in aChangeListeners");r.splice(o,1)};v.prototype.isKeyCreated=function(e){var t=e[h]!=null;return t};v.prototype.getEntryStatus=function(t){var r=t[a.Prefix];var o=r[a.PropName.Deleted];var n=r[a.PropName.IntStatus];var s=null;switch(n){case i.Empty:e(!o,"bDeleted should be cleared");s=l.Empty;break;case i.New:e(!o,"bDeleted should be cleared");s=l.New;break;case i.Modified:s=o?l.Deleted:l.Modified;break;case i.Unchanged:s=o?l.Deleted:l.Unchanged;break;default:e(false,"sIntStatus is unknown")}e(s!=null,"sStatus should be set");return s};v.prototype.createSaveInfo=function(e,t){var r={success:e,entryErrorInfos:t};return r};v.prototype._init=function(){this._oNodeMetadatas={};var e=this._getNodeInfos();this._parseNodeInfos(null,e,0);this._generateMethods();this.clearStorage()};v.prototype._parseNodeInfos=function(e,t,r){var a={};if(t){for(var o in t){var n=t[o];var s=this._parseNodeInfo(e,o,n,r);a[s.name]=s}}return a};v.prototype._parseNodeInfo=function(t,r,a,o){e(r!=d.NodeName,r+": reserved node name should not be used");e(!this._oNodeMetadatas[r],r+": node name should be unique");var n=a.keyFields;e(n&&n.length>0,r+": key fields should be defined");var s=a.keyed?true:false;if(s)e(!t,r+": keyed node should not have parent");var i=a.backendFetchRequest?a.backendFetchRequest:null;if(s)e(!i,r+": keyed node should not have fetch method");else e(i,r+": non-keyed node should have fetch method");var l=a.backendFetchEmptyRequest?a.backendFetchEmptyRequest:null;if(t&&t.backendCreateRequest)e(l,r+": node should have fetch empty method");else e(!l,r+": node should not have fetch empty method");var u=a.backendCreateRequest?a.backendCreateRequest:null;if(s)e(!u,r+": keyed node should not have create method");var h=a.backendUpdateRequest?a.backendUpdateRequest:null;if(s)e(!h,r+": keyed node should not have update method");var v=a.backendDeleteRequest?a.backendDeleteRequest:null;if(s)e(!v,r+": keyed node should not have delete method");var c=a.prepareEntry?a.prepareEntry:null;if(!u)e(!c,r+": node should not have prepareentry method");var f=a.getFieldNames?a.getFieldNames:null;if(u||h||v)e(f,r+": node should have fieldnames method");var p=a.getErrorLabel?a.getErrorLabel:null;if(u||h||v)e(p,r+": node should have errorlabel method");var g=a.forceReload?a.forceReload:null;if(g)e(u||h||v,r+": node should not have forcereload method");var y=a.isSingleEntry?a.isSingleEntry:null;if(y)e(u||v,r+": node should not have issingleentry method");var _=a.autoGrow?true:false;if(!u)e(!_,r+": node should not have autogrow enabled");var b=a.resetOnDelete?true:false;if(!v)e(!b,r+": node should not have resetondelete enabled");var E={name:r,level:o,parent:t,keyFields:n,keyed:s,backendFetchRequest:i,backendFetchEmptyRequest:l,backendCreateRequest:u,backendUpdateRequest:h,backendDeleteRequest:v,prepareEntry:c,getFieldNames:f,getErrorLabel:p,forceReload:g,isSingleEntry:y,autoGrow:_,resetOnDelete:b,collectionMethods:{}};this._oNodeMetadatas[E.name]=E;E.nodes=this._parseNodeInfos(E,a.nodes,o+1);return E};v.prototype._generateMethods=function(){for(var t in this._oNodeMetadatas){var r=this._oNodeMetadatas[t];e(t==r.name,"Node name mismatch");var a=r.parent;var o=a?a.name:null;var n=r.keyed;var s=this._haveChildNode(r);if(r.backendFetchRequest){var i="requestForFetch"+t;if(a)i+="By"+o+"Key";var l=function(){var e=r;var t=a?function(t,r){var a=this._requestForFetch(e,t,r);return a}:function(t){var r=this._requestForFetch(e,null,t);return r};return t};this._generateMethod(i,l())}if(r.backendCreateRequest){var i="create"+t;if(a)i+="By"+o+"Key";r.collectionMethods.create=jQuery.proxy(this._create,this,r);var l=function(){var e=r;var t=a?function(t,r,a,o){this._create(e,t,r,a,o)}:function(t,r,a){this._create(e,null,t,r,a)};return t};this._generateMethod(i,l())}if(r.backendCreateRequest||r.backendDeleteRequest){var i="delete"+t+"By";if(a)i+=o+"KeyAnd";i+="Index";r.collectionMethods.delete=jQuery.proxy(this._delete,this,r);var l=function(){var e=r;var t=a?function(t,r,a){this._delete(e,t,r,a)}:function(t,r){this._delete(e,null,t,r)};return t};this._generateMethod(i,l())}if(!a){var i="needSaveFor"+t;if(n)i+="ByKey";var l=function(){var e=r;var t=n?function(t){var r=this._needSave(e,t);return r}:function(){var t=this._needSave(e,null);return t};return t};this._generateMethod(i,l())}if(!a){var i="save"+t;if(n)i+="ByKey";var l=function(){var e=r;var t=n?function(t,r){this._save(e,t,r)}:function(t){this._save(e,null,t)};return t};this._generateMethod(i,l())}if(!a){var i="reset"+t;if(n)i+="ByKey";var l=function(){var e=r;var t=n?function(t){this._reset(e,t)}:function(){this._reset(e,null)};return t};this._generateMethod(i,l())}if(!n){var i="attachChangeFor"+t;if(a)i+="By"+o+"Key";r.collectionMethods.attachChange=jQuery.proxy(this._attachChangeFor,this,r);var l=function(){var e=r;var t=a?function(t,r){var a=this._attachChangeFor(e,t,r);return a}:function(t){var r=this._attachChangeFor(e,null,t);return r};return t};this._generateMethod(i,l())}{var i="compare"+t+"Key";var l=function(){var e=r;var t=function(t,r){var a=this._compareKey(e,t,r);return a};return t};this._generateMethod(i,l())}if(a&&s){var i="getParent"+o+"KeyBy"+t+"Key";var l=function(){var e=r;var t=function(t){var r=this._getParentKey(e,t);return r};return t};this._generateMethod(i,l())}{var i="extract"+t+"Key";r.collectionMethods.extractParentKey=a?jQuery.proxy(this._extractKey,this,a):null;var l=function(){var e=r;var t=function(t){var r=this._extractKey(e,t);return r};return t};this._generateMethod(i,l())}if(r.isSingleEntry){var i="isCreate"+t+"Enabled";if(a)i+="By"+o+"Key";r.collectionMethods.isCreateEnabled=jQuery.proxy(this._isCreateEnabled,this,r);var l=function(){var e=r;var t=a?function(t){var r=this._isCreateEnabled(e,t);return r}:function(){var t=this._isCreateEnabled(e,null);return t};return t};this._generateMethod(i,l())}}};v.prototype._generateMethod=function(e,t){this[e]=t};v.prototype._executeFetchRequestsContinue=function(t,r,a,o){var n={allSuccess:true,error:null,responses:[]};var s=null;var i=null;if(o){s=o.error;i=o.responses}if(s){n.error=s;n.allSuccess=false}else{var l=0;for(var u=0;u<r.length;u++){var d=r[u];var h=d.request;var v=null;var c=null;if(!h.passthru){var f=h.nodeMetadata;var p=h.parentKey;var g=null;var y=d.additional;e(y,"oAdditional should be set");var _=this._checkStorageParent(f,p);if(d.fetchResponseEntries){if(_){var b=d.fetchResponseEntries;g=this._executeFetchRequestsPutIntoStorage(f,p,b,y)}}else if(d.storageResponseChild){if(_)g=d.storageResponseChild}else{var E=i[l++];if(r[u].request.nodeMetadata.name=="DocLink"){_=true}if(_){var m=E.error;if(m){v=m;if(d.reload)this._executeFetchRequestsReloadCreateAutogrow(f,p)}else{if(f.name!="Phrase"){var b=E.response.entries}else{var b=E.response}g=this._executeFetchRequestsPutIntoStorage(f,p,b,y)}}}if(!v)c=g?g.collection:null}else{var E=i[l++];var m=E.error;if(m)v=m;else c=E.response}d.error=v;d.response=c;if(v)n.allSuccess=false}var S=n.responses;for(var u=0;u<t.length;u++)S.push(null);for(var u=0;u<r.length;u++){var d=r[u];var k=d.requestIndexes;var C={error:d.error,response:d.response};for(var R=0;R<k.length;R++){var M=k[R];S[M]=C}}}if(a){a(n,o)}};v.prototype._executeFetchRequestsPutIntoStorage=function(t,r,a,o){var n=this._getStorageParent(t,r,true);if(!n){var l=t.parent;e(l.keyed,"Parent node should be keyed");var u=o.parent;var d=this._extractKey(l,r);n=this._createStorageParent(l,d,null,u)}var h=n.keyRef;var v=this._haveChildNode(t);for(var c=0;c<a.length;c++){var f=a[c];if(f[s.Empty]){delete f[s.Empty];var p=a.slice(0,c);var g=this._createEntry(t,i.Empty,true,p,f,o);a[c]=g}else{this._prepareEntry(f,i.Unchanged,true)}}var y=a;if(this._getAutoGrowEnabled(t)){var _=this._createAutoGrowEntry(t,y,null,o);y.push(_)}if(t.name!="Phrase"){var b=this._getStorageChild(n,t)}else{var b}if(!b){b=this._createStorageChild(n,t,y,o);if(v){for(var c=0;c<y.length;c++){var E=y[c];this._createStorageParent(t,E,h,o)}}}else{var m=b.model;e(m,"oModel should be set");var S=m.getData();e(S,"aOldEntries should be set");var k={};for(var c=0;c<S.length;c++){var C=S[c];var R=this._keyToString(t,C);k[R]=C}var M=[];for(var c=0;c<y.length;c++){var E=y[c];var P=this._keyToString(t,E);var C=k[P];if(C){this._clearEntry(C,true);jQuery.extend(C,E);M.push(C);delete k[P]}else{M.push(E);if(v)this._createStorageParent(t,E,h,o)}}if(v){for(var R in k){var N=k[R];this._deleteStorageParent(t,N)}}this._updateStorageChild(b,M)}e(b.additional==o,"Additional data mismatch");this._invokeChangeListenersForFetch(b);return b};v.prototype._executeFetchRequestsReloadCreateAutogrow=function(t,r){var a=this._getStorageParent(t,r);var o=this._getStorageChild(a,t);e(o,"oStorageChild should be set");var n=o.model;e(n,"oModel should be set");var s=n.getData();e(s,"aEntries should be set");var i=o.additional;e(i,"oAdditional should be set");if(this._getAutoGrowEnabled(t)){var l=this._lookupAutoGrowEntry(s);if(!l){var l=this._createAutoGrowEntry(t,s,null,i);s.push(l);if(this._haveChildNode(t))this._createStorageParent(t,l,a.keyRef,i);this._updateStorageChild(o,s);this._invokeChangeListenersForFetch(o)}}};v.prototype._requestForFetch=function(e,t,r){var a={passthru:false,nodeMetadata:e,parentKey:t,reload:r};return a};v.prototype._create=function(t,r,a,o,n){var s=this._getStorageParent(t,r);var l=this._getStorageChild(s,t);e(l,"oStorageChild should be set");var u=l.model;e(u,"oModel should be set");var d=u.getData();e(d,"aEntries should be set");var h=l.additional;e(h,"oAdditional should be set");var v=this._getAutoGrowEnabled(t);var c=null;if(a){e(!n,"oNewEntryData should be null");if(v){var f=this._lookupAutoGrowEntry(d);if(!f){c=this._createAutoGrowEntry(t,d,o,h)}else if(o){jQuery.extend(f,o);this._updateStorageChild(l,d)}}}else{var f=null;if(v){f=this._lookupAutoGrowEntry(d);e(f,"oAutoGrowEntry should be set")}if(f){if(n)jQuery.extend(f,n);this._setEntryIntStatus(f,i.New);c=this._createAutoGrowEntry(t,d,o,h)}else{var p={};if(o)jQuery.extend(p,o);if(n)jQuery.extend(p,n);c=this._createEntry(t,i.New,false,d,p,h)}e(c,"oNewEntry should be set")}if(c){d.push(c);if(this._haveChildNode(t))this._createStorageParent(t,c,s.keyRef,h);this._updateStorageChild(l,d);this._invokeChangeListenersForCount(l)}};v.prototype._delete=function(t,r,n,s){var l=this._getStorageParent(t,r);var u=this._getStorageChild(l,t);e(u,"oStorageChild should be set");var d=u.model;e(d,"oModel should be set");var h=d.getData();e(h,"aEntries should be set");var v=u.additional;e(v,"oAdditional should be set");e(n<h.length,"iIndex should be < aEntries.length");var c=h[n];var f=c[a.Prefix];var p=f[a.PropName.Deleted];var g=p;if(p!=s){var y=false;if(s){var _=f[a.PropName.IntStatus];switch(_){case i.Empty:case i.New:var b=this._getAutoGrowEnabled(t);var E=f[a.PropName.AutoGrowEntry];if(_==i.Empty&&E){e(b,"autoGrow is not enabled for node")}else{if(!t.resetOnDelete){h.splice(n,1);if(this._haveChildNode(t))this._deleteStorageParent(t,c);p=true;if(b){var m=this._lookupAutoGrowEntry(h);e(m,"oAutoGrowEntry should be set");var S=h.length;e(S>=1,"iLength should be >= 1");var k=h.slice(0,S-1);this._updateAutoGrowEntry(t,k,m,v)}y=true}else{this._resetEntry(t,c);this._setEntryIntStatus(c,i.Empty);this._clearEntryError(c)}}break;case i.Modified:case i.Unchanged:p=true;break;default:e(false,"sIntStatus is unknown")}}else{p=false}f[a.PropName.Deleted]=p;this._updateStorageChild(u,h);if(g!=p){var C={modelDeleted:p,key:this._extractKey(t,c)};var R=this._createChangeEvent(o.DeleteChange,C);this._invokeChangeListeners(u,R)}if(y)this._invokeChangeListenersForCount(u)}};v.prototype._needSave=function(e,t){var r=this._collectBackendRequests(e,t);var a=r.backendRequests;var o=a.length>0;return o};v.prototype._save=function(e,t,r){var a=this._collectBackendRequests(e,t);var o=a.backendRequests;var n=function(e){if(r)r(e)};if(o.length>0){this._backendExecuteChangeRequests(o,jQuery.proxy(this._saveContinue,this,a,n))}else{this._showMessageToast("ModelManager.save.notNeeded");var s=this.createSaveInfo(true,[]);n(s)}};v.prototype._saveContinue=function(t,r,a){var o=this;if(a.allSuccess){this._clearAllErrors(t);var n=a.responses;for(var s=n.length-1;s>=0;s--){if(n[s].subRequest.messageKey=="PLMODataManager.error.qual.create"||n[s].subRequest.messageKey=="PLMODataManager.error.quant.create"){n[s].response=null}var i=n[s];var l=i.response;var d=i.entryInfo;e(d,"oEntryInfo should be set");this._processBackendResponse_Success(l,d)}this._updateModels(t);this._invokeKeyChangeListeners(t);var h=function(e){if(e.success)o._showMessageToast("ModelManager.save.success");var t=o.createSaveInfo(true,[]);r(t)};this._reloadImpl(t,"ModelManager.error.reloadaftersave",h)}else{var v=false;var c=null;if(a.error){v=true}else{c=[];this._clearAllErrors(t);var n=a.responses;var f=[];for(var s=0;s<n.length;s++){var i=n[s];var p=i.error;e(p,"oError should be set");var d=i.entryInfo;var g=this._processBackendResponse_Error(p,d);if(g.showError)f.push(i);var y=g.entryErrorInfo;if(y)c.push(y)}this._updateModels(t);if(f.length>0){a.responses=f;v=true}}var _=function(){var e=o.createSaveInfo(false,c);r(e)};if(v)u.showExecuteError(this._oComponent,"ModelManager.error.save",a,true,_);else _()}};v.prototype._collectBackendRequests=function(t,r){e(!t.parent,"Node should be top-level");var a=[];var o={createIndexesByNodeName:{},createIndex:0,changeInfos:[],reloadInfos:[]};if(!t.keyed){var n=this._collectBackendRequestsImpl(t,null,o,false);a=n.backendRequests}else{var s=t.nodes;for(var i in s){var l=s[i];var n=this._collectBackendRequestsImpl(l,r,o,true);a=a.concat(n.backendRequests)}}o.backendRequests=a;return o};v.prototype._collectBackendRequestsImpl=function(t,r,a,o){var n=this._getStorageParent(t,r);var s=this._getStorageChild(n,t);if(!s){e(o,"oStorageChild should be set");var i={backendRequests:[]};return i}var u=s.model;e(u,"oModel should be set");var d=u.getData();e(d,"aEntries should be set");var v=s.additional;e(v,"oAdditional should be set");var c={nodeMetadata:t,parentKeyRef:r,changedKeys:[]};var f=[];var p={};for(var g=0;g<d.length;g++){var y=d[g];var _=this.getEntryStatus(y);var b={changeInfo:c,index:g};var E=false;var m=null;switch(_){case l.Empty:case l.New:var S=this._createCreateInfo(t,r,y,a);m=t.backendCreateRequest(b,S,y,v);break;case l.Modified:E=true;m=t.backendUpdateRequest(b,y,v);break;case l.Unchanged:E=true;break;case l.Deleted:E=true;m=t.backendDeleteRequest(b,y,v);break;default:e(false,"sStatus is unknown")}if(E&&t.parent)e(r[h]==null,"Inconsistent parentkey-entry status");if(m){if(_==l.Empty)p[g]=f.length;f.push(m)}}var k=t.nodes;var C=[];for(var g=0;g<d.length;g++){var y=d[g];var _=this.getEntryStatus(y);var R=false;switch(_){case l.Empty:case l.New:case l.Modified:case l.Unchanged:R=true;break}if(R){var M=[];for(var P in k){var N=k[P];var i=this._collectBackendRequestsImpl(N,y,a,true);M=M.concat(i.backendRequests)}if(_==l.Empty&&M.length==0){var q=p[g];e(q!=null,"iEmptyBackendRequestIndex should be set");f[q]=null}C=C.concat(M)}}var I=[];for(var g=0;g<f.length;g++){var m=f[g];if(m)I.push(m)}if(I.length>0){var x=a.changeInfos;x.push(c);var w=t.forceReload;if(w){var F=w(r,v);a.reloadInfos=a.reloadInfos.concat(F)}}I=I.concat(C);var i={backendRequests:I};return i};v.prototype._createCreateInfo=function(t,r,a,o){e(a[h]!=null,"Create key field should be set");var n=o.createIndexesByNodeName;var s=t.name;var i=n[s];if(!i)i=n[s]={};var l=this._keyToString(t,a);var u=o.createIndex++;e(i[l]==null,"oCreateIndexesByKey should not contain sKey");i[l]=u;var d={createIndex:u,parentKey:null,parentIndex:null};var v=t.parent;if(!v||r[h]==null){d.parentKey=r}else{var c=this._keyToString(v,r);i=n[v.name];e(i,"oCreateIndexesByKey should be set");var f=i[c];e(f!=null,"iParentIndex should be set");d.parentIndex=f}return d};v.prototype._processBackendResponse_Success=function(t,r){var o=r.changeInfo;var n=o.nodeMetadata;var s=o.parentKeyRef;var d=r.index;var h=this._getStorageParent(n,s);var v=this._getStorageChild(h,n);e(v,"oStorageChild should be set");var c=v.model;e(c,"oModel should be set");var f=c.getData();e(f,"aEntries should be set");var p=v.additional;e(p,"oAdditional should be set");e(d<f.length,"iIndex should be < aEntries.length");var g=f[d];var y=false;var _=this.getEntryStatus(g);switch(_){case l.Empty:case l.New:this._setEntryIntStatus(g,i.Unchanged);var b=t;e(b,"oNewRawKey should be set");this._processBackendResponse_Success_Rename(n,g,b,o,true);y=true;break;case l.Modified:this._setEntryIntStatus(g,i.Unchanged);var b=t;if(b&&!this._compareKey(n,g,b))this._processBackendResponse_Success_Rename(n,g,b,o,false);y=true;break;case l.Deleted:var E=!n.resetOnDelete;if(E){f.splice(d,1)}else{this._setEntryIntStatus(g,i.Unchanged);y=true}if(this._haveChildNode(n))this._deleteStorageParent(n,g,!E);break;default:e(false,"sStatus is unknown")}if(y){var m=u.copy(g);delete m[a.Prefix];var S=g[a.Prefix];S[a.PropName.OrigEntry]=m;S[a.PropName.ForceReset]=false}};v.prototype._processBackendResponse_Success_Rename=function(t,r,a,o,n){var s=this._extractKey(t,r);if(n){e(r[h]!=null,"Create key field should be set");delete r[h]}var i=this._extractKey(t,a);jQuery.extend(r,i);if(this._haveChildNode(t))this._renameStorageParent(t,s,i);var l=o.changedKeys;var u={oldKey:s,newKey:i};l.push(u)};v.prototype._processBackendResponse_Error=function(t,r){var a={showError:true,entryErrorInfo:null};if(!r)return a;var o=r.changeInfo;var n=o.nodeMetadata;var s=o.parentKeyRef;var i=r.index;var l=this._getStorageParent(n,s);var u=this._getStorageChild(l,n);e(u,"oStorageChild should be set");var d=u.model;e(d,"oModel should be set");var h=d.getData();e(h,"aEntries should be set");var v=u.additional;e(v,"oAdditional should be set");var c=n.getFieldNames(v);var f=t.fieldErrorsByField;var p={};var g=[];var y=false;var _=false;for(var b in f){var E=f[b];if(c.fieldNames.indexOf(b)>=0){delete f[b];p[b]=E;y=true}else if(c.entryError){delete f[b];g=g.concat(E);y=true}else{_=true}}var m=null;if(y){e(i<h.length,"iIndex should be < aEntries.length");var S=h[i];this._setEntryError(S,g,p);var k=n.getErrorLabel(S,v);var C=this._getEntryPaths(n,S);m={label:k,entryPaths:C,entryErrors:g,fieldErrorsByField:p}}var R=t.details.length>0||!y||_;a.showError=R;a.entryErrorInfo=m;return a};v.prototype._reloadImpl=function(t,r,a){var o=[];var n=this;var s=function(e,t){var r=n._requestForFetch(e,t,true);o.push(r)};var i=t.changeInfos;for(var l=0;l<i.length;l++){var u=i[l];var d=u.nodeMetadata;var h=u.parentKeyRef;s(d,h)}var v=t.reloadInfos;for(var l=0;l<v.length;l++){var c=v[l];var d=this._oNodeMetadatas[c.nodeName];e(d,"oNodeMetadata should be set");var h=c.parentKey;s(d,h)}this.executeFetchRequests(o,jQuery.proxy(this._reloadImplContinue,this,r,a))};v.prototype._reloadImplContinue=function(e,t,r){var a=this;if(r.allSuccess){var o=this._createReloadInfo(true);t(o)}else{var n=function(){var e=a._createReloadInfo(false);t(e)};u.showExecuteError(this._oComponent,e,r,true,n)}};v.prototype._reset=function(e,t){if(!e.keyed){this._resetImpl(e,null,false)}else{var r=e.nodes;for(var a in r){var o=r[a];this._resetImpl(o,t,true)}}};v.prototype._resetImpl=function(t,r,o){var n=this._getStorageParent(t,r);var s=this._getStorageChild(n,t);if(!s){e(o,"oStorageChild should be set");return}var u=s.model;e(u,"oModel should be set");var d=u.getData();e(d,"aEntries should be set");var v=s.additional;e(v,"oAdditional should be set");var c=null;if(this._getAutoGrowEnabled(t)){c=this._lookupAutoGrowEntry(d);e(c,"oAutoGrowEntry should be set")}var f=[];var p=false;for(var g=0;g<d.length;g++){var y=d[g];var _=y[a.Prefix];var b=_[a.PropName.OrigEntry];var E=_[a.PropName.ForceReset];var m=this.getEntryStatus(y);var S=false;var k=null;var C=false;switch(m){case l.Empty:if(E){if(b){e(y!=c,"Autogrow entry can't have original data");k=i.Empty}else{e(y==c,"Entry should be the autogrow entry");p=true}}else if(_[a.PropName.Error]){S=true}break;case l.New:if(b){k=i.Empty}else{f.push(g);p=true}break;case l.Modified:k=i.Unchanged;C=true;break;case l.Unchanged:if(E)k=i.Unchanged;C=true;break;case l.Deleted:_[a.PropName.Deleted]=false;k=i.Unchanged;C=true;break;default:e(false,"sStatus is unknown")}if(C&&t.parent)e(r[h]==null,"Inconsistent parentkey-entry status");if(k!=null){this._resetEntry(t,y);this._setEntryIntStatus(y,k);S=true}if(S){this._clearEntryError(y);p=true}}if(p&&c)f.push(d.length-1);for(var g=f.length-1;g>=0;g--){var R=f[g];var y=d[R];d.splice(R,1);if(this._haveChildNode(t))this._deleteStorageParent(t,y)}if(p&&c){c=this._createAutoGrowEntry(t,d,null,v);d.push(c);if(this._haveChildNode(t))this._createStorageParent(t,c,n.keyRef,v)}var M=t.nodes;for(var g=0;g<d.length;g++){var y=d[g];for(var P in M){var N=M[P];this._resetImpl(N,y,true)}}if(p){this._updateStorageChild(s,d);this._invokeChangeListenersForFetch(s)}};v.prototype._clearAllErrors=function(e){var t=e.changeInfos;for(var r=0;r<t.length;r++){var a=t[r];var o=a.nodeMetadata;var n=a.parentKeyRef;this._clearErrors(o,n)}};v.prototype._clearErrors=function(t,r){var a=this._getStorageParent(t,r);var o=this._getStorageChild(a,t);e(o,"oStorageChild should be set");var n=o.model;e(n,"oModel should be set");var s=n.getData();e(s,"aEntries should be set");for(var i=0;i<s.length;i++){var l=s[i];this._clearEntryError(l)}};v.prototype._updateModels=function(t){var r=t.changeInfos;for(var a=0;a<r.length;a++){var o=r[a];var n=o.nodeMetadata;var s=o.parentKeyRef;var i=this._getStorageParent(n,s);var l=this._getStorageChild(i,n);e(l,"oStorageChild should be set");var u=l.model;e(u,"oModel should be set");var d=u.getData();e(d,"aEntries should be set");this._updateStorageChild(l,d)}};v.prototype._invokeKeyChangeListeners=function(t){var r=t.changeInfos;for(var a=0;a<r.length;a++){var n=r[a];var s=n.changedKeys;if(s.length>0){var i=n.nodeMetadata;var l=n.parentKeyRef;var u=this._getStorageParent(i,l);var d=this._getStorageChild(u,i);e(d,"oStorageChild should be set");var h={changedKeys:s};var v=this._createChangeEvent(o.Key,h);this._invokeChangeListeners(d,v)}}};v.prototype._attachChangeFor=function(t,r,a){var o=this._getStorageParent(t,r);var n=this._getStorageChild(o,t);e(n,"oStorageChild should be set");var s=n.changeListeners;e(s,"aChangeListeners should be set");s.push(a);var i={changeListeners:s,changeListener:a,aliveObj:this._oAliveObj};return i};v.prototype._compareKey=function(e,t,r){var a=this._keyToString(e,t);var o=this._keyToString(e,r);var n=a==o;return n};v.prototype._getParentKey=function(t,r){var a=this._getDirectStorageParent(t,r);var o=t.parent;e(o,"oParentNodeMetadata should be set");var n=this._extractKey(o,a.parentKeyRef);return n};v.prototype._isCreateEnabled=function(t,r){var a=this._getStorageParent(t,r);var o=this._getStorageChild(a,t);e(o,"oStorageChild should be set");var n=o.model;e(n,"oModel should be set");var s=n.getData();e(s,"aEntries should be set");var i=o.additional;e(i,"oAdditional should be set");var l=this._isMoreEntryAllowed(t,s,i);return l};v.prototype._getEntryPaths=function(e,t){var r=[];while(e){var a=this._extractKey(e,t);var o={nodeName:e.name,key:a};r.splice(0,0,o);var n=this._getDirectStorageParent(e,t);e=e.parent;t=n.parentKeyRef}return r};v.prototype._getStorageParent=function(t,r,a){var o=t.parent;var n=null;var s=null;var i=false;if(o){n=o.name;s=this._keyToString(o,r);if(a)i=o.keyed}else{n=d.NodeName;s=d.Key}e(n!=null,"sParentNodeName should be set");e(s!=null,"sParentKey should be set");var l=null;var u=this._oStorage[n];if(u)l=u[s];if(!i)e(l,"oStorageParent should be set");return l};v.prototype._getDirectStorageParent=function(t,r){var a=t.name;var o=this._keyToString(t,r);var n=this._oStorage[a];e(n,"oStorageNode should be set");var s=n[o];e(s,"oStorageParent should be set");return s};v.prototype._checkStorageParent=function(t,r){var a=t.parent;var o=null;if(a){if(!a.keyed){var n=a.name;var s=this._keyToString(a,r);var i=null;var l=this._oStorage[n];if(l)i=l[s];o=i?true:false}else{o=true}}else{o=true}e(o!=null,"bResult should be set");return o};v.prototype._createStorageParent=function(t,r,a,o){var n=t.name;var s=this._oStorage[n];if(!s)s=this._oStorage[n]={};var i=this._keyToString(t,r);e(!s[i],"oStorageNode should not contain sKey");e(o,"oAdditional should be set");var l={child:{},additional:o,keyRef:r,parentKeyRef:a};s[i]=l;return l};v.prototype._renameStorageParent=function(t,r,a){var o=t.name;var n=this._keyToString(t,r);var s=this._keyToString(t,a);var i=this._oStorage[o];e(i,"oStorageNode should be set");var l=i[n];e(l,"oStorageParent should be set");e(!i[s],"oStorageNode should not contain sNewKey");i[s]=l;delete i[n]};v.prototype._deleteStorageParent=function(t,r,a){var o=t.name;var n=this._oStorage[o];e(n,"oStorageNode should be set");var s=this._keyToString(t,r);var i=n[s];e(i,"oStorageParent should be set");var l=t.nodes;for(var u in l){var d=l[u];var h=this._haveChildNode(d);var v=i.child[d.name];if(h&&v){var c=v.model;e(c,"oModel should be set");var f=c.getData();e(f,"aEntries should be set");for(var p=0;p<f.length;p++){var g=f[p];this._deleteStorageParent(d,g)}}}if(a){i.child={}}else{delete n[s];if(Object.keys(n).length==0)delete this._oStorage[o]}};v.prototype._getStorageChild=function(e,t){var r=e.child[t.name];return r};v.prototype._createStorageChild=function(t,a,o,s){var i=t.child;var l=a.name;e(!i[l],"oStorageChildren should not contain sNodeName");e(o,"aEntries should be set");var u=new r(o);e(s,"oAdditional should be set");var d=new n(t.keyRef,u,s,a.collectionMethods,this._oAliveObj);var h={model:u,additional:s,changeListeners:[],collection:d};i[l]=h;return h};v.prototype._updateStorageChild=function(t,r){var a=t.model;e(a,"oModel should be set");e(r,"aEntries should be set");a.setData(r)};v.prototype._haveChildNode=function(e){return true};v.prototype._invokeChangeListenersForFetch=function(e){var t={model:e.model};var r=this._createChangeEvent(o.Fetch,t);this._invokeChangeListeners(e,r)};v.prototype._invokeChangeListenersForCount=function(e){var t=this._createChangeEvent(o.Count,{});this._invokeChangeListeners(e,t)};v.prototype._invokeChangeListeners=function(t,r){var a=t.changeListeners;e(a,"aChangeListeners should be set");var o=a.slice(0);for(var n=0;n<o.length;n++){var s=o[n];s(r)}};v.prototype._createChangeEvent=function(e,t){var r={type:e};if(t)jQuery.extend(r,t);return r};v.prototype._createEntry=function(e,t,r,a,o,n){var s={};s[h]=this._iCreateIndex++;var i=e.prepareEntry;if(i)i(a,s,n);if(o)jQuery.extend(s,o);this._prepareEntry(s,t,r);return s};v.prototype._lookupAutoGrowEntry=function(e){var t=e.length;var r=null;if(t>0){var o=e[t-1];var n=o[a.Prefix];var s=n[a.PropName.IntStatus];var l=n[a.PropName.AutoGrowEntry];if(s==i.Empty&&l)r=o}return r};v.prototype._createAutoGrowEntry=function(t,r,o,n){e(this._getAutoGrowEnabled(t),"autoGrow is not enabled for node");var s=this._createEntry(t,i.Empty,false,r,o,n);var l=s[a.Prefix];l[a.PropName.AutoGrowEntry]=true;this._updateAutoGrowVisible(t,r,s,n);return s};v.prototype._updateAutoGrowEntry=function(t,r,a,o){e(this._getAutoGrowEnabled(t),"autoGrow is not enabled for node");this._updateAutoGrowVisible(t,r,a,o);var n=t.prepareEntry;if(n)n(r,a,o)};v.prototype._updateAutoGrowVisible=function(e,t,r,o){var n=r[a.Prefix];n[a.PropName.AutoGrowVisible]=this._isMoreEntryAllowed(e,t,o)};v.prototype._prepareEntry=function(t,r,o){e(r==i.Empty||r==i.New||r==i.Unchanged,"Invalid internal status");if(r==i.New)e(!o,"bStoreOrig should be false");var n=o?u.copy(t):null;var s=t[a.Prefix]={};s[a.PropName.Error]=false;s[a.PropName.ErrorMessage]=null;s[a.PropName.Deleted]=false;s[a.PropName.Field]={};s[a.PropName.IntStatus]=r;s[a.PropName.AutoGrowEntry]=false;s[a.PropName.AutoGrowVisible]=false;s[a.PropName.OrigEntry]=n;s[a.PropName.ForceReset]=false};v.prototype._resetEntry=function(t,r){var o=r[a.Prefix];var n=o[a.PropName.OrigEntry];e(n,"oOrigEntry should be set");e(this._compareKey(t,r,n),"Key should be unchanged");this._clearEntry(r,false);var s=u.copy(n);jQuery.extend(r,s);o[a.PropName.ForceReset]=false};v.prototype._clearEntry=function(e,t){for(var r in e){if(t||r!=a.Prefix)delete e[r]}};v.prototype._setEntryIntStatus=function(e,t){var r=e[a.Prefix];r[a.PropName.IntStatus]=t};v.prototype._setEntryError=function(t,r,o){e(r.length>0||Object.keys(o).length>0,"aEntryErrors or oFieldErrorsByField should contain at least one error");var n=t[a.Prefix];n[a.PropName.Error]=true;if(r.length>0){var s=r.join("\n");n[a.PropName.ErrorMessage]=s}for(var i in o){var l=o[i];var u=l.join("\n");n[a.PropName.Field][i]=u}};v.prototype._clearEntryError=function(e){var t=e[a.Prefix];t[a.PropName.Error]=false;t[a.PropName.ErrorMessage]=null;t[a.PropName.Field]={}};v.prototype._keyToString=function(t,r){var a=r[h]!=null?[h]:t.keyFields;var o=[];for(var n=0;n<a.length;n++){var s=a[n];var i=r[s];e(i!=null,s+": key field should be set");var l=s+'="'+i.toString().replace(/"/g,'""')+'"';o.push(l)}var u=o.join(",");return u};v.prototype._extractKey=function(t,r){var a=r[h]!=null?[h]:t.keyFields;var o={};for(var n=0;n<a.length;n++){var s=a[n];var i=r[s];e(i!=null,s+": key field should be set");o[s]=i}return o};v.prototype._isMoreEntryAllowed=function(e,t,r){var a=e.isSingleEntry;var o=!(t.length>0&&a&&a(r));return o};v.prototype._createReloadInfo=function(e){var t={success:e};return t};v.prototype._requestToString=function(t,r){e(!t.passthru,"Request should be normal request");if(t.nodeMetadata.name!="Phrase"){var a=t.nodeMetadata;var o=a.parent;var n=t.parentKey;if(r)e(o,"oParentNodeMetadata should be set");var s=r?o.name:a.name;var i=s+"/"+(o?this._keyToString(o,n):"");return i}else{var a=t.nodeMetadata;var i=a.name+"/"+a.Phrkey;return i}};v.prototype._compareRequestInfo=function(e,t){var r=e.request;var a=t.request;if(r.passthru&&!a.passthru)return-1;else if(!r.passthru&&a.passthru)return 1;else if(r.passthru&&a.passthru)return 0;return r.nodeMetadata.level-a.nodeMetadata.level};v.prototype._showMessageToast=function(e){var r=this._oComponent.getI18nBundle().getText(e);t.show(r)};v.prototype._getComponent=function(){return this._oComponent};v.prototype._getNodeInfos=function(){e(false,"_getNodeInfos should be overridden in derived class")};v.prototype._backendExecuteFetchRequests=function(t,r){e(false,"_backendExecuteFetchRequests should be overridden in derived class")};v.prototype._backendExecuteChangeRequests=function(t,r){e(false,"_backendExecuteChangeRequests should be overridden in derived class")};v.prototype._executeFetchRequestsBegin=function(){};v.prototype._executeFetchRequestsEnd=function(){};v.prototype._getAutoGrowEnabled=function(e){return false};return v});