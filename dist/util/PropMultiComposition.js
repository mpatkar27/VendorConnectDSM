sap.ui.define(["sap/ui/model/json/JSONModel","gramont/VCDSM/specedit/util/PropBase","gramont/VCDSM/specedit/util/MultilevelAdd","gramont/VCDSM/specedit/util/ModelManagerAdmin","gramont/VCDSM/specedit/util/ModelManagerAutoGrowOp","gramont/VCDSM/specedit/util/ModelManagerIntStatus","sap/m/MessageToast","sap/base/assert"],function(t,e,i,s,l,o,n,h){"use strict";var a=function(i,s,l,o,n,h,a,r,c,f){e.call(this,i,"gramont.VCDSM.specedit.frag.PropMultiComposition");this._subsec=this._byId("mlcsubsec");r[f].propid=this._subsec;this._subsec.setVisible(c.Visible);this._estcat=s.ESTCAT;this._oComponent=i;this.speckey=h;this.estcat=a;var p=new t;this.cl1=this._byId("Cl1");this.cl2=this._byId("Cl2");this.cl3=this._byId("Cl3");this.OBref=this._byId("OBRef");this.treetable=this._byId("MultiComp");this.cl1cnt=0;this.colinf2=[];this.colinf3=[];this.coldat2=[];this.coldat3=[];this.delnodepaths=[];var d=this.getControl();d.setModel(p,"propModel");p.setProperty("/title",s.TEXT);var g=this._byId("MultiComp");var E=l.getModel().getData();for(var _=0;_<E.length;_++){if(E[_].EXP_LEVEL==""){E.splice(_,1);_--}}this._acompsr=l.getModel();var v=0,u=0,V,P;var T=[],C=[];this.levelcnt1=0;this.levelcnt2=0;this.levelcnt3=0;for(var m=0;m<E.length;m++){if(E[m].EXP_LEVEL==1){E[m].ITOTVALVIS0=true;E[m].ITOTVALVIS1=false;E[m].ITOTVALVIS2=false;E[m].ITOTVALVIS3=false;E[m].ADDCHDBTN=true}else if(E[m].EXP_LEVEL==2){E[m].ITOTVALVIS0=false;E[m].ITOTVALVIS1=true;E[m].ITOTVALVIS2=false;E[m].ITOTVALVIS3=false;E[m].ADDCHDBTN=true;this.levelcnt1++}else if(E[m].EXP_LEVEL==3){E[m].ITOTVALVIS0=false;E[m].ITOTVALVIS1=false;E[m].ITOTVALVIS2=true;E[m].ITOTVALVIS3=false;E[m].ADDCHDBTN=true;this.levelcnt2++}else if(E[m].EXP_LEVEL==4){E[m].ITOTVALVIS0=false;E[m].ITOTVALVIS1=false;E[m].ITOTVALVIS2=false;E[m].ITOTVALVIS3=true;E[m].ADDCHDBTN=false;this.levelcnt3++}else{E[m].ADDCHDBTN=false}E[m].DELFLG=""}for(var m=0;m<E.length;m++){for(var L=0;L<E.length;L++){if(E[m].ITEM_KEY==E[L].PARENT_KEY&&E[m].EXP_LEVEL<E[L].EXP_LEVEL){v++}if(L!=0&&E[L].EXP_LEVEL>V){V=E[L].EXP_LEVEL}else if(L==0){V=E[0].EXP_LEVEL}}E[m].NoofChildnodes=v;v=0}for(m=E.length-1;m>=0;m--){for(L=0;L<E.length;L++){if(E[m].ITEM_KEY==E[L].PARENT_KEY&&E[m].EXP_LEVEL<E[L].EXP_LEVEL){T[u]=E[L];u++}}E[m].aCompositions=T;T=[];u=0}for(m=0;m<E.length;m++){if(E[m].PARENT_KEY=="0"){C.push(E[m])}}var y=new sap.ui.model.json.JSONModel(C);this._compnewr=y;g.setModel(y);this._referval()};a.prototype=Object.create(e.prototype);a.prototype.constructor=a;a.prototype._ontogglestate=function(t){var e=t.getSource().getModel().getProperty(t.getParameters().rowContext.sPath+"/EXP_LEVEL");var i=t.getParameters().rowContext.sPath;var s=t.getParameters().expanded;var l=t.getSource().getModel();var o=t.getSource().getModel().getProperty(t.getParameters().rowContext.sPath+"/ITEM_KEY");if(s==true){if(e==1){this.cl1.setVisible(true);this.cl1cnt++}else if(e==2){this.cl2cnt=this.colinf2.length;this.cl2.setVisible(true);this.coldat2["vis"]=true;this.coldat2["path"]=i;this.colinf2[this.cl2cnt]=jQuery.extend({},this.coldat2)}else if(e==3){var n=i.split("/");var h;for(var a=1;a<4;a++){if(a==1)h="/"+n[a];else h=h+"/"+n[a]}this.cl3.setVisible(true);this.cl3cnt=this.colinf3.length;this.coldat3["vis"]=true;this.coldat3["path"]=i;this.coldat3["pathsec"]=h;this.colinf3[this.cl3cnt]=jQuery.extend({},this.coldat3)}}else{if(e==1){if(this.cl1cnt==1){this.cl1.setVisible(false);this.cl2.setVisible(false);this.cl3.setVisible(false);this.cl1cnt--;this.colinf1=[];this.colinf2=[];this.colinf3=[];this.cl2cnt=0;this.cl3cnt=0}else if(this.cl1cnt>1&&this.colinf2.length==0&&this.colinf3.length==0){this.cl1cnt--}else if(this.cl1cnt>1&&this.colinf2.length!=0){if(this.colinf3.length==0){for(var r=0;r<this.colinf2.length;r++){if(l.getProperty(this.colinf2[r].path+"/PARENT_KEY")==o&&this.colinf2.length==1){this.cl2.setVisible(false);this.colinf2.splice(r,1)}else if(l.getProperty(this.colinf2[r].path+"/PARENT_KEY")==o&&this.colinf2.length>1){this.colinf2.splice(r,1)}}this.cl1cnt--}else{for(r=0;r<this.colinf3.length;r++){if(l.getProperty(this.colinf3[r].pathsec+"/PARENT_KEY")==o&&this.colinf3.length==1&&this.colinf2.length==1){this.cl3.setVisible(false);this.cl2.setVisible(false);this.colinf3=[];this.colinf2.splice(0,1)}else if(l.getProperty(this.colinf3[r].pathsec+"/PARENT_KEY")==o&&this.colinf3.length!=1&&this.colinf2.length==1){this.cl3.setVisible(false);this.cl2.setVisible(false);this.colinf3=[];this.colinf2.splice(0,1)}else if(l.getProperty(this.colinf3[r].pathsec+"/PARENT_KEY")==o&&this.colinf3.length!=1&&this.colinf2.length>1){this.colinf3.splice(r,1)}else if(l.getProperty(this.colinf3[r].pathsec+"/PARENT_KEY")==o&&this.colinf3.length==1&&this.colinf2.length>1){this.colinf3.splice(r,1);this.cl3.setVisible(false);for(var c=0;c<this.colinf2.length;c++){if(l.getProperty(this.colinf2[c].path+"/PARENT_KEY")==o&&this.colinf2.length==1){this.cl2.setVisible(false);this.colinf2.splice(c,1)}else if(l.getProperty(this.colinf2[c].path+"/PARENT_KEY")==o&&this.colinf2.length>1){this.colinf2.splice(c,1)}}}}this.cl1cnt--}}}else if(e==2){for(r=0;r<this.colinf2.length;r++){if(this.colinf2.length==1&&this.colinf3.length==0){this.cl2.setVisible(false);this.colinf2.splice(r,1)}else if(this.colinf2.length==1&&this.colinf3.length==1&&l.getProperty(this.colinf2[r].path+"/ITEM_KEY")==o&&l.getProperty(this.colinf3[0].path+"/PARENT_KEY")==o){this.cl2.setVisible(false);this.colinf2.splice(r,1);this.cl3.setVisible(false);this.colinf3.splice(r,1)}else if(this.colinf2.length>1&&l.getProperty(this.colinf2[r].path+"/ITEM_KEY")==o){for(c=0;c<this.colinf3.length;c++){if(l.getProperty(this.colinf3[c].path+"/PARENT_KEY")==o&&this.colinf3.length>1){this.colinf3.splice(c,1)}else if(l.getProperty(this.colinf3[c].path+"/PARENT_KEY")==o&&this.colinf3.length==1){this.colinf3.splice(c,1);this.cl3.setVisible(false)}}this.colinf2.splice(r,1)}}}else if(e==3){for(c=0;c<this.colinf3.length;c++){if(this.colinf3.length==1){this.cl3.setVisible(false);this.colinf3=[]}else if(this.colinf3.length>1){if(o==l.getProperty(this.colinf3[c].path+"/ITEM_KEY")){this.colinf3.splice(c,1)}}}}}};a.prototype.addchildnode=function(t){this._childnodepath=t.getSource().getBindingContext().getPath();var e=this._compnewr.getProperty(this._childnodepath).ITEM_KEY;if(e==""){n.show(this._oComponent.getI18nBundle().getText("errorcnodecreation"))}else{var s=true;var l=new i(this._oComponent,this._childnodepath,this._compnewr,this._acompsr,s,this.OBref,this.speckey,this.estcat)}};a.prototype.addparentnode=function(t){var e=this._compnewr.getData().length;var s="/"+(e-1);var l=false;var o=new i(this._oComponent,s,this._compnewr,this._acompsr,l,this.OBref,this.speckey,this.estcat)};a.prototype._onChange=function(t){var e=t.getSource().getBindingContext().getPath();var i=t.getSource().getModel();var l=i.getData().length;var n=e+"/"+s.FullPropName.IntStatus;var h=i.getProperty(n);var a=null;switch(h){case o.Empty:a=o.New;break;case o.Unchanged:a=o.Modified;break}if(a!=null)i.setProperty(n,a);this._referval()};a.prototype._Expandall=function(t){this.treetable.expandToLevel(4);var e=this._acompsr.getData();for(var i=0;i<e.length;i++){if(e[i].EXP_LEVEL==2){this.levelcnt1++}else if(e[i].EXP_LEVEL==3){this.levelcnt2++}else if(e[i].EXP_LEVEL==4){this.levelcnt3++}}if(this.levelcnt1>0)this.cl1.setVisible(true);if(this.levelcnt2>0)this.cl2.setVisible(true);if(this.levelcnt3>0)this.cl3.setVisible(true);this.colinf2=[];this.colinf3=[];this.cl1cnt=0;var s=this._compnewr.getData();for(var l=0;l<s.length;l++){if(s[l].NoofChildnodes>0){var o=s[l].aCompositions;for(var n=0;n<o.length;n++){var h="/"+l+"/aCompositions/"+n;if(o[n].NoofChildnodes>0){var a=o[n].aCompositions;for(var r=0;r<a.length;r++){var c=c+"/aCompositions/"+r;if(a[r].NoofChildnodes>0){var f=c.split("/");var p;for(var d=1;d<4;d++){if(d==1)p="/"+f[d];else p=p+"/"+f[d]}this.cl3cnt=this.colinf3.length;this.coldat3["vis"]=true;this.coldat3["path"]=c;this.coldat3["pathsec"]=p;this.colinf3[this.cl3cnt]=jQuery.extend({},this.coldat3)}}this.cl2cnt=this.colinf2.length;this.cl2.setVisible(true);this.coldat2["vis"]=true;this.coldat2["path"]=h;this.colinf2[this.cl2cnt]=jQuery.extend({},this.coldat2)}}this.cl1cnt++}}};a.prototype._Collapseall=function(t){this.treetable.collapseAll();this.cl1.setVisible(false);this.cl2.setVisible(false);this.cl3.setVisible(false);this.colinf2=[];this.colinf3=[];this.cl1cnt=0};a.prototype._Delflagset=function(t){if(!this._clearselect){var e=t.getParameter("rowIndex");var i=t.getSource().getSelectedIndices();var s=t.getParameters().rowContext.sPath;if(i.indexOf(e)==-1){for(var l=0;l<this.delnodepaths.length;l++){if(this.delnodepaths[l]==s){this.delnodepaths.splice(l,1)}}}else{this.delnodepaths[this.delnodepaths.length]=s}}else{this._clearselect=false}};a.prototype.deletenode=function(t){var e=null,i=null,s=null,l=null,n=[];for(var h=0;h<this.delnodepaths.length;h++){e=this._compnewr.getProperty(this.delnodepaths[h]);e.DELFLG="X";e._ModelManagerADMIN.intStatus=o.Modified;if(e.NoofChildnodes>0){for(var a=0;a<e.NoofChildnodes;a++){i=this._compnewr.getProperty(this.delnodepaths[h]+"/aCompositions");i[a].DEFLG="X";i[a]._ModelManagerADMIN.intStatus=o.Modified;if(i[a].NoofChildnodes>0){for(var r=0;r<i[a].NoofChildnodes;r++){s=this._compnewr.getProperty(this.delnodepaths[h]+"/aCompositions/"+a+"/aCompositions");s[r].DELFLG="X";s[r]._ModelManagerADMIN.intStatus=o.Modified;if(s[r].NoofChildnodes>0){for(var c=0;c<s[r].NoofChildnodes;c++){l=this._compnewr.getProperty(this.delnodepaths[h]+"/aCompositions/"+a+"/aCompositions/"+r+"/aCompositions");l[c].DELFLG="X";l[a]._ModelManagerADMIN.intStatus=o.Modified}}}}}}}this._clearselect=true;this.treetable.clearSelection();var f=this._compnewr.getData();for(var p=0;p<f.length;p++){if(f[p].NoofChildnodes>0){var d=f[p].aCompositions;for(var g=0;g<d.length;g++){if(d[g].NoofChildnodes>0){var E=d[g].aCompositions;for(var _=0;_<E.length;_++){if(E[_].NoofChildnodes>0){var v=E[_].aCompositions;for(var u=0;u<v.length;u++){if(v[u].DELFLG=="X"){v.splice(u,1);u--;E[_].NoofChildnodes--}}}if(E[_].DELFLG=="X"){E.splice(_,1);_--;d[g].NoofChildnodes--}}}if(d[g].DELFLG=="X"){d.splice(g,1);g--;f[p].NoofChildnodes--}}}if(f[p].DELFLG=="X"){f.splice(p,1);p--}}this._compnewr.refresh();this.delnodepaths=[];this._referval();this._Collapseall()};a.prototype._referval=function(){var t=0,e=null;var i=this._compnewr.getData();for(var s=0;s<i.length;s++){t=t+parseInt(i[s].COMPAVG)}if(t<100){e="Warning"}else{e="Success"}t=t+"%";this.OBref.setText(t);this.OBref.setState(e)};a.prototype._infopop=function(e){this._oevent=e;var i="/sap/opu/odata/GMT/VC_ODATA_SRV";var s=new sap.ui.model.odata.ODataModel(i,true);var l=this;var o={method:"GET",urlParameters:{ESTCAT:l._estcat},context:null,success:function(e,i){l._oDialogadd=l._oComponent.getNavigator().createFragment("gramont.vc.specedit.frag.helpopup",l);l._Odiahelp=new t;l._Odiahelp.setProperty("/aData",e.Info);l._oDialogadd.control.setModel(l._Odiahelp,"resModel");l._oDialogadd.control.openBy(l._oevent.getSource());l.getOwnerComponent().getNavigator().releaseBusyDialog()},error:function(t){sap.m.MessageToast.show(t.message);l.getOwnerComponent().getNavigator().releaseBusyDialog()},async:true};s.callFunction("/GetVatInfo",o);this.getOwnerComponent().getNavigator().requireBusyDialog()};return a});