sap.ui.define(["sap/base/assert","sap/m/Label","sap/m/MultiInput","sap/m/Token","sap/ui/model/json/JSONModel","sap/ui/comp/smartfield/SmartField","gramont/VCDSM/specedit/control/Column","gramont/VCDSM/specedit/control/ColumnListItem","gramont/VCDSM/specedit/util/TableManager","gramont/VCDSM/specedit/util/PropBase","gramont/VCDSM/specedit/util/ModelManagerAdmin","gramont/VCDSM/specedit/util/ModelManagerAutoGrowOp","gramont/VCDSM/specedit/util/ModelManagerIntStatus","sap/ui/richtexteditor/RichTextEditor","gramont/VCDSM/specedit/util/UsageDiag","gramont/VCDSM/specedit/util/CharEditCommon","gramont/VCDSM/specedit/util/AddCountry","sap/ui/model/Filter","sap/ui/model/FilterOperator","gramont/VCDSM/specedit/util/LangValueHelp"],function(e,t,a,r,i,o,s,l,n,d,u,p,g,h,v,c,_,m,y,f){"use strict";var b=function(t,s,l,n,p,h,v,_,f,b){d.call(this,t,"gramont.VCDSM.specedit.frag.PropInstance");this._oCollection=l;this._oComponent=t;this._layout=v;this._udtinst=h;this._treenode=s;this._estcat=s.ESTCAT;this._subsec=this._byId("instsubsec");_[b].propid=this._subsec;this._subsec.setVisible(f.Visible);this._proplist=_;var C=new i;var M=this.getControl();M.setModel(C,"propModel");C.setProperty("/title",s.TEXT);var P=this._byId("table");P.setEditable(n);var D=this._byId("ColLay");var S=this._byId("grp1");var E=function(e){var t=e.getSource().getModel("prog").getData().header;var a=e.getSource().getModel("prog").getData().valbindpath.split("/");var r=parseInt(a[0]);var i=e.getSource().getModel();var o=i.getData().length;var s="/"+r+"/"+u.FullPropName.IntStatus;var l=i.getProperty(s);var n=null;switch(l){case g.Empty:n=g.New;break;case g.Unchanged:n=g.Modified;break}if(n!=null)i.setProperty(s,n);if(e.getSource().getValue)var d=e.getSource().getValue();else{var d=e.getSource().getState();if(t._Linked_prop!=""&&t._isCheckBox){var p=e.getSource().getModel("prog").getData().proplist;for(var h=0;h<p.length;h++){if(p[h].PropListId==t._Linked_prop){var v=p[h].propid;v.setVisible(d)}}}}if(!t._isCheckBox){this._src=e.getSource();var c=[];c["ATNAM"]=t.getFieldName();c["ATWRT"]=e.getSource().getValue();var _=this._oComponent.getODataManager().requestForValidateInput(c);this._oComponent.getODataManager().executeRequest(_,jQuery.proxy(this._ValinputSuccess,this))}};var N=function(e,t){if(!this._oEditDialog)this._oEditDialog=new c(this._oComponent);this._oEditDialog.open(this,e,t)};var V=function(e,t,a){var r=a.getSource().getModel("prog").getData().valbindpath.split("/");var i=parseInt(r[0]);var o=e.getEntry(i);this._inpsrc=a.getSource();if(!this._oEditDialog)this._oEditDialog=new c(this._oComponent);this._oEditDialog.open(t,o,jQuery.proxy(this._onCharEditStore,this,t,i,e))};var T=function(e,t,a){var r=this;if(a.getParameters()[0]instanceof sap.m.Input){a.getParameters()[0].setValueHelpOnly(a.getSource().getProperty("showValueHelp"));a.getParameters()[0].setShowValueHelp(a.getSource().getProperty("showValueHelp"));a.getParameters()[0].setModel(a.getSource().getModel());a.getParameters()[0].attachValueHelpRequest(jQuery.proxy(V,r,this._oCollection,t));if(t._datatype=="NUM"){a.getParameters()[0].setType("Number");a.getParameters()[0].setMaxLength(t._datalength)}if(t._datatype=="CHAR"){a.getParameters()[0].setMaxLength(t._datalength)}}};if(l.getAdditional().charHeaderInfo!=null){var x=l.getAdditional().charHeaderInfo.byOrder;for(var I=x.length-1;I>=0;I--){var w=x[I];if(w._coledit=="")var A=false;else var A=true;var L=w._bIsMultiValue;var R=w.getLabel();var O=null;var F=null;if(R!=t.getI18nBundle().getText("PropInstance.sortOrder")){if(w._valuehelppresent=="X"){var k=true}else{var k=false}this._valhelp=k;var G=new sap.ui.comp.smartform.GroupElement({label:R});var j=new i;j.setProperty("/radbtn",w._isCheckBox);if(w._bIsRealPhrase||w._FLG_IS_PHR=="D"){if(w._isCheckBox){var B=new sap.m.Switch({state:"{/0/"+w._sFieldName+"/0/value}",enabled:n&&A,change:E});G.insertElement(B);S.insertGroupElement(G);j.setProperty("/valbindpath","0/"+w._sFieldName+"/0/value");j.setProperty("/multiinput",false);j.setProperty("/proplist",_);j.setProperty("/header",w);B.setModel(j,"prog");if(w._Linked_prop!=""){for(var Q=0;Q<_.length;Q++){if(_[Q].PropListId==w._Linked_prop){_[Q].Visible=l.getModel().getProperty("/0/"+w._sFieldName+"/0/value")}}}}else{if(L){var H=new a({editable:n&&A,required:w._mandatory,change:jQuery.proxy(E,this),showValueHelp:k,valueHelpOnly:k,valueHelpRequest:jQuery.proxy(V,this,this._oCollection,w)});var U=l.getModel().getProperty("/0/"+w._sFieldName);for(var X=0;X<U.length;X++){H.addToken(new r({text:U[X].value,key:U[X].phrase,editable:false}))}j.setProperty("/multiinput",true);j.setProperty("/header",w)}else if(w._datatype!="DATE"){var H=new o({value:"{/0/"+w._sFieldName+"/0/value}",textLabel:R,editable:n&&A,mandatory:w._mandatory,change:jQuery.proxy(E,this),showValueHelp:k,innerControlsCreated:jQuery.proxy(T,this,this._oCollection,w)});j.setProperty("/multiinput",false);j.setProperty("/header",w)}else{var q=new sap.m.DatePicker({dateValue:"{/0/"+w._sFieldName+"/0/value}",change:jQuery.proxy(E,this),editable:n&&A});q.addEventDelegate({onAfterRendering:function(){var e=this.$().find(".sapMInputBaseInner");var t=e[0].id;$("#"+t).attr("disabled","disabled")}},q);j.setProperty("/multiinput",false);j.setProperty("/header",w)}if(w._datatype!="DATE"){G.insertElement(H);S.insertGroupElement(G);j.setProperty("/valbindpath","0/"+w._sFieldName+"/0/value");H.setModel(j,"prog")}else{G.insertElement(q);S.insertGroupElement(G);j.setProperty("/valbindpath","0/"+w._sFieldName+"/0/value");q.setModel(j,"prog")}}}else{if(w._isCheckBox){var B=new sap.m.Switch({state:"{/0/"+w._sFieldName+"/0/value}",enabled:n&&A,change:E});G.insertElement(B);S.insertGroupElement(G);j.setProperty("/valbindpath","0/"+w._sFieldName+"/0/value");j.setProperty("/multiinput",false);j.setProperty("/proplist",_);j.setProperty("/header",w);B.setModel(j,"prog");if(w._Linked_prop!=""){for(var Q=0;Q<_.length;Q++){if(_[Q].PropListId==w._Linked_prop){_[Q].Visible=l.getModel().getProperty("/0/"+w._sFieldName+"/0/value")}}}}else{if(L){var H=new a({editable:n&&A,required:w._mandatory,change:jQuery.proxy(E,this),showValueHelp:k,valueHelpOnly:k,valueHelpRequest:jQuery.proxy(V,this,this._oCollection,w)});var U=l.getModel().getProperty("/0/"+w._sFieldName);for(var X=0;X<U.length;X++){H.addToken(new r({text:U[X].value,key:U[X].phrase,editable:false}))}j.setProperty("/multiinput",true);j.setProperty("/header",w)}else if(w._datatype!="DATE"){var H=new o({value:"{/0/"+w._sFieldName+"/0}",textLabel:R,editable:n&&A,mandatory:w._mandatory,change:jQuery.proxy(E,this),showValueHelp:k,innerControlsCreated:jQuery.proxy(T,this,this._oCollection,w)});j.setProperty("/multiinput",false);j.setProperty("/header",w)}else{var q=new sap.m.DatePicker({dateValue:"{/0/"+w._sFieldName+"/0}",change:jQuery.proxy(E,this),editable:n&&A});q.addEventDelegate({onAfterRendering:function(){var e=this.$().find(".sapMInputBaseInner");var t=e[0].id;$("#"+t).attr("disabled","disabled")}},q);j.setProperty("/multiinput",false);j.setProperty("/header",w)}if(w._datatype!="DATE"){G.insertElement(H);S.insertGroupElement(G);j.setProperty("/valbindpath","0/"+w._sFieldName+"/0");H.setModel(j,"prog")}else{G.insertElement(q);S.insertGroupElement(G);j.setProperty("/valbindpath","0/"+w._sFieldName+"/0");q.setModel(j,"prog")}}}}}P.setModel(l.getModel());var J=this._byId("delbtn");J.setVisible(n);var K=this._byId("udtinstadd");K.setVisible(n);var W=this._byId("addbtn");W.setVisible(n);var Y=this._byId("cb_udtinst");Y.setVisible(n)}var z=function(t){var a=t.getSource().getBindingContext().getPath().split("/");e(a.length==2&&a[0]=="","Control should have absolute binding context path");var r=parseInt(a[1]);var i=t.getSource().getModel();var o=t.getSource().getSelected();var s=i.getData().length;var l;if(o)l="X";else l="";var n="/"+r+"/DELFLAG";i.setProperty(n,l);var n="/"+r+"/"+u.FullPropName.IntStatus;var d=i.getProperty(n);var p=null;switch(d){case g.Empty:p=g.New;break;case g.Unchanged:p=g.Modified;break}if(p!=null)i.setProperty(n,p)};var Z=this._byId("udt");this._udttab=Z;var ee=this._byId("udt1");this._udttab1=ee;var te=this._byId("udt");if(v=="UDT_INST"){P.setVisible(false);Z.setVisible(false)}else{P.setVisible(true);Z.setVisible(true)}if(this._udtinst){var ae=this._byId("cb1");ae.setEditable(n);var re=this._byId("cb_lang");re.setEditable(n);this._byId("Rtc1").setEditable(n);ee.setVisible(true);if(n){J.setVisible(true);W.setVisible(true);K.setVisible(true);Y.setVisible(true)}this._oldudt=p.collection.getModel();var ie=p.collection.getModel().getData();for(var oe=0;oe<ie.length;oe++){ie[oe].LAYOUT=this._layout;ie[oe].DELFLAG=""}this._oldudt.setData(ie);var se=p.collection.getModel().getData();var le=[];for(var oe=0;oe<se.length;oe++){le.push(se[oe])}var ne=new sap.ui.model.json.JSONModel(le);var de=[],ue,pe=false;for(var X=0;X<le.length;X++){for(var ge=0;ge<de.length;ge++){if(de[ge].ORD==le[X].ORD)pe=true;else pe=false}if(!pe){de.push(le[X])}}var he=new sap.ui.model.json.JSONModel(de);Y.setModel(he);this._cmbbxmod=he;this._udtmod=ne;ee.setModel(ne);this._cmbbxudt=Y;if(le.length!=0){Y.setSelectedKey(ne.getData()[0].ORD);var ve=Y.getSelectedKey();var ce=[];if(ve){ce.push(new m("ORD",y.Contains,ve))}var _e=this._udttab1.getBinding("items");_e.filter(ce)}}else{ee.setVisible(false);if(n){J.setVisible(false);W.setVisible(false);K.setVisible(false);Y.setVisible(false)}if(p!=null){var me=new sap.m.ColumnListItem;for(var ye=0;ye<2;ye++){if(ye==0){O=new sap.m.Label({});O.setText(t.getI18nBundle().getText("Name"));F=new sap.m.Column({header:O,width:"20%"})}else if(ye==1){O=new sap.m.Label({});O.setText(t.getI18nBundle().getText("val"));F=new sap.m.Column({header:O})}te.addColumn(F)}me.addCell(new sap.m.Label({text:"{TEXTNAM}"}));me.addCell(new sap.ui.richtexteditor.RichTextEditor({value:"{TEXT}",change:E,editable:n,width:"100%"}));te.bindItems("/",me,null,null);var se=p.collection.getModel().getData();var ne=new sap.ui.model.json.JSONModel(se);Z.setModel(ne)}else{Z.setVisible(false)}}};b.prototype=Object.create(d.prototype);b.prototype.constructor=b;b.prototype._ValinputSuccess=function(e){if(e.results[0]){this._src.setValueState("Error");this._src.setValueStateText(e.results[0].MESSAGE)}else{this._src.setValueState("None");this._src.setValueStateText("")}};b.prototype._Langvalhelp=function(e){var t=e.getSource();var a=new f(this._oComponent,this._treenode,this._udtmod,this._oldudt,t)};b.prototype._onCharEdit=function(e,t,a){var r=e.getEntryIndexOfControl(a.getSource());var i=e.getEntry(r);t.openEdit(i,jQuery.proxy(this._onCharEditStore,this,t,r,e))};b.prototype._onCmbChange=function(e){var t=e.getSource().getModel();var a=e.getSource().getSelectedKey();var r=[];if(a){r.push(new m("ORD",y.Contains,a))}var i=this._udttab1.getBinding("items");i.filter(r)};b.prototype._oneditinst=function(t){var a=t.getSource().getBindingContext().getPath().split("/");e(a.length==2&&a[0]=="","Control should have absolute binding context path");var r=parseInt(a[1]);var i=t.getSource().getModel();var o="/"+r+"/";var s=i.getProperty(o);var l=new v(this._oComponent,s,this._treenode)};b.prototype._onselect=function(t){var a=t.getSource().getBindingContext().getPath().split("/");e(a.length==2&&a[0]=="","Control should have absolute binding context path");var r=parseInt(a[1]);var i=t.getSource().getModel();var o=t.getSource().getSelected();var s=i.getData().length;var l;if(o)l="X";else l="";var n="/"+r+"/DELFLAG";i.setProperty(n,l);var n="/"+r+"/"+u.FullPropName.IntStatus;var d=i.getProperty(n);var p=null;switch(d){case g.Empty:p=g.New;break;case g.Unchanged:p=g.Modified;break}if(p!=null)i.setProperty(n,p)};b.prototype._onChange=function(t){var a=t.getSource().getBindingContext().getPath().split("/");e(a.length==2&&a[0]=="","Control should have absolute binding context path");var r=parseInt(a[1]);var i=t.getSource().getModel();var o=i.getData().length;var s="/"+r+"/"+u.FullPropName.IntStatus;var l=i.getProperty(s);var n=null;switch(l){case g.Empty:n=g.New;break;case g.Unchanged:n=g.Modified;break}if(n!=null)i.setProperty(s,n)};b.prototype._onDelete=function(e){var t=this._udtmod.getData();for(var a=0;a<t.length;a++){if(t[a].DELFLAG=="X"){t.splice(a,1);a--}}this._udtmod.refresh()};b.prototype._onAdd=function(e){var t=this._udtmod.getData();var a=this._cmbbxudt.getSelectedKey();if(a!=""){if(t.length!=0){for(var r=0;r<t.length;r++){if(t[r].ORD==a){var i=t[r]}}if(i!=""&&!i){var o=jQuery.extend(true,{},i);o.ORD=a;o._ModelManagerADMIN.intStatus=g.Modified;o.DELFLAG="";o.TEXT="";o.RECN="0";o.LANGU=""}else{var s=this._oldudt.getProperty(this._cmbbxudt.getSelectedItem().getBindingContext().sPath);var o=jQuery.extend(true,{},s);o._ModelManagerADMIN.intStatus=g.Modified;o.DELFLAG="";o.TEXT="";o.RECN="0";o.LANGU=""}}else{var s=this._oldudt.getProperty(this._cmbbxudt.getSelectedItem().getBindingContext().sPath);var o=jQuery.extend(true,{},s);o._ModelManagerADMIN.intStatus=g.Modified;o.DELFLAG="";o.TEXT="";o.RECN="0";o.LANGU=""}var l=this._oldudt.getData();l.push(o);t.push(o);this._udtmod.refresh()}else{var n=this._oComponent.getI18nBundle().getText("validinstance");sap.m.MessageToast.show(n)}};b.prototype._onAddCountry=function(e){var t=new _(this._oComponent,this._treenode,this._udtmod,this._oldudt)};b.prototype._onCharEditStore=function(e,t,a,i,o){a.setFieldValue(t,e.getFieldName(),i,o);var s=this._inpsrc.getModel("prog").getData().multiinput;if(s)this._inpsrc.removeAllTokens();if(s){for(var l=0;l<i.length;l++){this._inpsrc.addToken(new r({text:i[l].value,key:i[l].phrase,editable:false}))}}};b.prototype._CreateInstanceSuccess=function(e){var t=this._udtmod.getData();if(t.length!=0){var a=jQuery.extend(true,{},t[t.length-1]);a.ACTN=e.ACTN;a.ORD="0001";a.RECNPARENT=e.RECNPARENT;a.RECNROOT=e.RECNROOT;a.ACTN_VP=e.ACTN_VP;a.RECN_VP=e.RECN_VP;a._ModelManagerADMIN.intStatus=g.Modified;a.DELFLAG="";var r=this._oldudt.getData();r.push(a);t.push(a);this._udtmod.refresh()}else{t=this._oldudt.getData();var a=jQuery.extend(true,{},t[0]);a.ACTN=e.ACTN;a.RECNPARENT=e.RECNPARENT;a.RECNROOT=e.RECNROOT;a.ACTN_VP=e.ACTN_VP;a.RECN_VP=e.RECN_VP;a._ModelManagerADMIN.intStatus=g.Modified;a.DELFLAG="";var r=this._oldudt.getData();if(r[0].RECN=="0"){r.splice(0,1);r.push(a)}var t=this._udtmod.getData();t.push(a);this._udtmod.refresh()}};b.prototype._infopop=function(e){this._oevent=e;var t="/sap/opu/odata/GMT/VC_ODATA_SRV";var a=new sap.ui.model.odata.ODataModel(t,true);var r=this;var o={method:"GET",urlParameters:{ESTCAT:r._estcat},context:null,success:function(e,t){r._oDialogadd=r._oComponent.getNavigator().createFragment("gramont.VCDSM.specedit.frag.helpopup",r);r._Odiahelp=new i;r._Odiahelp.setProperty("/aData",e.Info);r._oDialogadd.control.setModel(r._Odiahelp,"resModel");r._oDialogadd.control.openBy(r._oevent.getSource());r.getOwnerComponent().getNavigator().releaseBusyDialog()},error:function(e){sap.m.MessageToast.show(e.message);r.getOwnerComponent().getNavigator().releaseBusyDialog()},async:true};a.callFunction("/GetVatInfo",o);this.getOwnerComponent().getNavigator().requireBusyDialog()};return b});