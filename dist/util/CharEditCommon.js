sap.ui.define(["sap/base/assert","sap/m/ColumnListItem","sap/m/ListMode","sap/m/Text","sap/ui/core/VerticalAlign","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","gramont/VCDSM/specedit/util/Util"],function(e,t,a,o,r,i,s,l,h){"use strict";var n=function(e){e.initClassExtension(this,"gramont.VCDSM.specedit.util.CharEditCommon",arguments);this._oComponent=e;this._oDialog=this._oComponent.getNavigator().createFragment("gramont.VCDSM.specedit.frag.CharEditCommon",this);this._oDialogDialogModel=new l;this._oDialog.control.setModel(this._oDialogDialogModel,"dialogModel");var t=this._oDialog.byId("table");this._oDialogTableModel=new l;t.setModel(this._oDialogTableModel)};n.prototype.open=function(e,t,a){this._oCharHeader=e;this._oInstance=t;this._fOnStore=a;if(this._oCharHeader.getValueHelper())this._fetchCharValue();else this._open2([])};n.prototype._fetchCharValue=function(){var e=this._oInstance;if(this._oComponent.getModelManager().isKeyCreated(e))e=this._oComponent.getModelManager().getParentPropertyKeyByInstanceKey(e);var t=this._extHookRequestForFetchCharValue?this._extHookRequestForFetchCharValue(e,this._oInstance,this._oCharHeader):this._oComponent.getODataManager().requestForFetchCharValue(e,this._oCharHeader);this._oComponent.getODataManager().executeRequest(t,jQuery.proxy(this._fetchCharValueSuccess,this))};n.prototype._fetchCharValueSuccess=function(e){this._open2(e)};n.prototype._open2=function(t){this._oDialogDialogModel.setProperty("/visibleCreate",this._oCharHeader.getMultiValue()&&this._oCharHeader.getAdditionalValues());this._oDialogDialogModel.setProperty("/tableMode",this._oCharHeader.getMultiValue()?a.MultiSelect:a.SingleSelectLeft);var o=this._oDialog.byId("search");o.setValue("");for(var r=0;r<t.length;r++){var i=t[r];this._setCharEntryProp(i,false,false)}var s=null;if(!this._oCharHeader.getMultiValue()){if(this._extHookDisplayEmptyCharEntry&&this._extHookDisplayEmptyCharEntry(this._oCharHeader)){var l=this._oComponent.getI18nBundle().getText("CharEditCommon.empty.charDescr");s=this._createEmptyCharEntry(false,false,l)}}var n=h.copy(this._oInstance[this._oCharHeader.getFieldName()]);var u=[];var p=false;for(var r=0;r<n.length;r++){var _=n[r];var d=false;if(this._oCharHeader.isEmptyCharValue(_)){if(s){this._setCharEntryProp(s,null,true);p=true}continue}for(var c=0;c<t.length;c++){var i=t[c];d=this._oCharHeader.isCharValueEqual(_,i.charValue);if(d){this._setCharEntryProp(i,null,true);p=true;break}}if(!d){var i=this._oCharHeader.createCharEntryFromCharValue(_);this._setCharEntryProp(i,true,true);u.push(i)}}if(s)t.splice(0,0,s);t=t.concat(u);if(!this._oCharHeader.getMultiValue()&&this._oCharHeader.getAdditionalValues()&&u.length==0){var i=this._createEmptyCharEntry(true,!p);t.push(i)}this._oDialogTableModel.setData([]);this._setupFilter();if(this._extHookSetupTable)this._extHookSetupTable(t);var g=this._oDialog.byId("table");g.bindItems({path:"/",factory:jQuery.proxy(this._itemFactory,this)});this._oDialogTableModel.setData(t);e(!this._oDialog.control.isOpen(),"oDialog should be closed");this._oDialog.control.open()};n.prototype._close=function(){this._oDialog.control.close()};n.prototype._setupFilter=function(){var e=this._oDialog.byId("search");var t=e.getValue();var a=[];if(t!=""){var o=[];var r=this._oCharHeader.getCharEntryFilterPath();if(r!=null){var l=new i({path:r,operator:s.Contains,value1:t});o.push(l)}var h=new i({path:"description",operator:s.Contains,value1:t});o.push(h);var n=new i({filters:o,and:false});a=[n]}if(this._extHookSetupFilter)this._extHookSetupFilter(t,a);var u=this._oDialog.byId("table");var p=u.getBinding("items");if(p)p.filter(a)};n.prototype._setCharEntryProp=function(e,t,a){if(t!=null)e._editable=t;if(a!=null)e._selected=a};n.prototype._createEmptyCharEntry=function(e,t,a){var o=this._oCharHeader.createEmptyCharEntry(a);this._setCharEntryProp(o,e,t);return o};n.prototype._itemFactory=function(e,a){var i=new t({vAlign:r.Middle,selected:{path:"_selected"}});var s;if(!a.getProperty("_editable")){s=this._oCharHeader.getCharEntryLabel()}else{s=this._oCharHeader.getCharEntryInput()}var l=new o({text:{path:"description"}});i.addCell(l);if(this._extHookItemFactory)this._extHookItemFactory(a,i);return i};n.prototype._onCreate=function(){var e=this._oDialogTableModel.getData();var t=this._createEmptyCharEntry(true,true);e.push(t);this._oDialogTableModel.setData(e)};n.prototype._onSearch=function(){this._setupFilter()};n.prototype._onSelect=function(t){if(!this._oCharHeader.getMultiValue()){e(t.getParameter("selected"),"selected should be set");var a=t.getSource();var o=parseInt(a.getSelectedContextPaths()[0].substr(1));e(!isNaN(o),"iSelectedIndex should be a number");var r=this._oDialogTableModel.getData();for(var i=0;i<r.length;i++){if(i!=o){var s=r[i];this._setCharEntryProp(s,null,false)}}}};n.prototype._onOK=function(){this._close();var e=this._oDialogTableModel.getData();var t=[];for(var a=0;a<e.length;a++){var o=e[a];if(o._selected)t.push(o)}var r=this._oCharHeader.createCharValuesFromCharEntries(t);this._fOnStore(r,false)};n.prototype._onCancel=function(){this._close()};return n});