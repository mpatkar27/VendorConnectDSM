sap.ui.define(["sap/base/assert","sap/m/ButtonType","sap/m/CheckBox","sap/ui/core/Icon","sap/ui/core/TextAlign","sap/ui/core/ValueState","sap/ui/model/BindingMode","sap/ui/model/Filter","sap/ui/model/FilterOperator","gramont/VCDSM/specedit/control/AlwaysEnabled","gramont/VCDSM/specedit/control/Column","gramont/VCDSM/specedit/control/DestroyListener","gramont/VCDSM/specedit/util/ModelManagerAdmin","gramont/VCDSM/specedit/util/ModelManagerIntStatus","gramont/VCDSM/specedit/util/TableManagerConst","gramont/VCDSM/specedit/util/Util"],function(t,e,o,r,i,n,a,l,s,p,u,h,d,c,m,y){"use strict";var f=function(e,n,l){this._oComponent=e;this._oTable=n;this._oFilter=null;this._aSorters=null;t(this._oTable.isA("gramont.VCDSM.specedit.control.Table"),"oTable should be an instance of gramont.VCDSM.specedit.control.Table");l.bindProperty("error",{path:d.FullPropName.Error});l.bindProperty("tooltip",{path:d.FullPropName.ErrorMessage});l.bindProperty("deleted",{path:d.FullPropName.Deleted});var s=new r({src:"sap-icon://delete"});this._oHeaderDeleteColumn=new u({header:s,hAlign:i.Center,width:"3rem"});this._oTable.insertColumn(this._oHeaderDeleteColumn,0);this.setTableDeleteVisible(true);var c=new o({selected:{path:d.FullPropName.Deleted,mode:a.OneWay},enabled:{path:"appModel>/editMode"},select:jQuery.proxy(this._onDelete,this)});this._oEntryDeleteColumn=new p({control:c});l.insertCell(this._oEntryDeleteColumn,0);this.setEntryDeleteVisible(null);l.bindProperty("autoGrow",{parts:[{path:d.FullPropName.IntStatus},{path:d.FullPropName.AutoGrowEntry}],formatter:jQuery.proxy(this._formatAutoGrow,this)});var m=l.getCells().slice(1);this._prepareControls(m);this._oTable.bindItems({path:"/",template:l});this._fEditModeChange=jQuery.proxy(this._editModeChange,this);this._oComponent.attachEditModeChange(this._fEditModeChange);var y=new h;y.setDestroyCallback(jQuery.proxy(this._destroy,this));this._oTable.addDependent(y)};f.prototype.setCollection=function(t){this._oCollection=t;this._oTable.setModel(this._oCollection.getModel());this._setupBinding()};f.prototype.setFilter=function(t){this._oFilter=t;this._setupBinding()};f.prototype.setSorter=function(t){this._aSorters=t;this._setupBinding()};f.prototype.setTableDeleteVisible=function(t){this._oHeaderDeleteColumn.setVisible(t)};f.prototype.setEntryDeleteVisible=function(e){var o=[{path:d.FullPropName.IntStatus},{path:d.FullPropName.AutoGrowEntry}];var r=null;if(e){var i=e.path;t(i!=null,"sPath should be set");var n={path:i};o.push(n);r=e.formatter;if(!r){r=function(t){return t}}}var a={parts:o,formatter:jQuery.proxy(this._formatDeleteVisible,this,r)};this._oEntryDeleteColumn.bindProperty("visible",a)};f.prototype._prepareControls=function(t){for(var e=0;e<t.length;e++){var o=t[e];this._prepareControl(o)}};f.prototype._prepareControl=function(t){if(!t)return;var e=null;var o=null;if(t.isA("sap.ui.layout.HorizontalLayout")){this._prepareControls(t.getContent())}else if(t.isA("gramont.VCDSM.specedit.control.CharValueControl")){this._prepareControl(t.getInnerControl());this._prepareControl(t.getEditButton())}else if(t.isA("gramont.VCDSM.specedit.control.Field")){this._prepareControl(t.getDisplay());this._prepareControl(t.getEdit())}else if(t.isA(["sap.m.Link","sap.m.Text","sap.ui.core.Icon"])){t.addStyleClass("gramontPlmVc_TableManager_VAlign")}else if(t.isA("sap.m.Button")){e=this._getFieldErrorBindingPath(t,null);if(e!=null){t.bindProperty("type",{path:e,formatter:jQuery.proxy(this._formatType,this)})}}else if(t.isA("sap.m.CheckBox")){e=this._getFieldErrorBindingPath(t,"selected");if(e!=null){t.bindProperty("valueState",{path:e,formatter:jQuery.proxy(this._formatValueState,this)})}o=t.attachSelect}else if(t.isA("sap.m.InputBase")){e=this._getFieldErrorBindingPath(t,"value");if(e!=null){t.bindProperty("valueState",{path:e,formatter:jQuery.proxy(this._formatValueState,this)})}o=t.attachLiveChange;if(!o)o=t.attachChange}if(e!=null){t.bindProperty("tooltip",{path:e})}if(o)o.call(t,jQuery.proxy(this._onChange,this))};f.prototype._getFieldErrorBindingPath=function(t,e){var o=null;var r=t.data(m.FieldName);if(e!=null&&r==null)r=t.getBindingPath(e);if(r!=null){y.checkFieldName(r);o=d.FullPropName.Field+"/"+r}return o};f.prototype._setupBinding=function(){var t=this._oTable.getBinding("items");if(!t)return;var e=[];var o=new l({path:d.FullPropName.IntStatus,operator:s.NE,value1:c.Empty});var r=new l({path:d.FullPropName.AutoGrowEntry,operator:s.EQ,value1:false});var i=[o,r];if(this._oComponent.getEditMode()){var n=new l({path:d.FullPropName.AutoGrowVisible,operator:s.EQ,value1:true});i.push(n)}var a=new l({filters:i,and:false});e.push(a);if(this._oFilter)e.push(this._oFilter);var p=new l({filters:e,and:true});t.filter([p]);t.sort(this._aSorters)};f.prototype._editModeChange=function(){this._setupBinding()};f.prototype._destroy=function(){this._oComponent.detachEditModeChange(this._fEditModeChange)};f.prototype._formatDeleteVisible=function(t,e,o,r){var i=!(e==c.Empty&&o);if(t)i=i&&t(r);return i};f.prototype._formatAutoGrow=function(t,e){var o=t==c.Empty&&e;return o};f.prototype._formatValueState=function(t){var e=t!=null?n.Error:n.None;return e};f.prototype._formatType=function(t){var o=t!=null?e.Reject:e.Default;return o};f.prototype._onDelete=function(t){var e=t.getSource();var o=this._oCollection.getEntryIndexOfControl(e);var r=t.getParameter("selected");this._oCollection.delete(o,r);var i=this._oCollection.getModel();var n=i.getProperty("/"+o+"/"+d.FullPropName.Deleted);if(n!=null&&n!=e.getSelected())e.setSelected(n)};f.prototype._onChange=function(t){var e=this._oCollection.getEntryIndexOfControl(t.getSource());this._oCollection.updateEntryStatus(e)};return f});