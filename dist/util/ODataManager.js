sap.ui.define(["sap/base/assert","sap/ui/model/odata/ODataModel","gramont/VCDSM/specedit/util/ODataManagerException","gramont/VCDSM/specedit/util/Util"],function(e,r,t,a){"use strict";var o="/GMT/VC/ERROR";var s="RECORD";var n="";var i=function(e){this._oComponent=e;this._oModel=null};i.prototype.init=function(e,t,a){this._checkInit(true);this._oComponent.getNavigator().requireBusyDialog();var o=this._getServiceURL();this._oModel=new r(o,true,null,null,null,null,null,true);var s=this;var n=function(){if(t)t();s._oComponent.getNavigator().releaseBusyDialog()};var i=function(r){s._oComponent.getNavigator().releaseBusyDialog();var t=s._parseODataError(e,r);var o=function(){if(a)a(t)};s._showError(t,o)};this._oModel.attachMetadataLoaded(n);this._oModel.attachMetadataFailed(i)};i.prototype.isInited=function(){var e=this._oModel&&this._oModel.getServiceMetadata();return e};i.prototype.getSecurityToken=function(){this._checkInit();var e=this._oModel.getSecurityToken();return e};i.prototype.requestForMergeRequests=function(r){this._checkInit();e(r.length>0,"aSubRequests.length should be > 0");var a="ODataManager.error.mergeRequestError";var o=this;var s=r[0].change?true:false;var i=null;if(s){i=this._requestForDoPostponeError();var l=[i];r=[].concat(l,r)}var u=[];var v=[];for(var c=0;c<r.length;c++){var p=r[c];var h=p.change?true:false;var f=p.batchRequests;e(s==h,"Requests in aSubRequests should be either change or non-change requests, but not both");e(!p.transformError,"oSubRequest.transformError should be cleared");e(f.length>0,"aSubBatchRequests.length should be > 0");u=u.concat(f);for(var g=0;g<f.length;g++)v.push(p)}e(u.length==v.length,"length mismatch");var d=function(s){var n=[];var l=[];var u=[];var v=0;for(var c=0;c<r.length;c++){var p=r[c];var h=p.batchRequests;var f=h.length;var g=v+f;var d=s.slice(v,g);v=g;var _={error:null,response:null,subRequest:p};var y=p!=i;try{var m=p.process;var b=m?m(d):null;var E=p.postProcess;_.response=E?E(b):b;if(y)n.push(_)}catch(r){if(!(r instanceof t))throw r;var O=o._oComponent.getI18nBundle().getText(r.detailKey,r.args);var R=_.error=o._createError(p.messageKey,[O],null,r.data);e(y,"ODataManagerException is not allowed for _requestForDoPostponeError");l.push(_);u=o._buildDetails(u,R)}}var M=l.length>0;var S={responses:M?l:n};if(M){S.details=u;throw new t(a,null,S)}return S};var _=function(r){var t=[];var s=[];var l=r.errorObjsByOpIndex;e(l,"oErrorObjsByOpIndex should be set");var u=Object.keys(l);u.sort(jQuery.proxy(o._opIndexSorter,o));for(var c=0;c<u.length;c++){var p=u[c];var h=p!=n;var f=l[p];var g=null;if(h){var d=parseInt(p);e(!isNaN(d),"iOpIndex should be an integer");g=v[d]}var _={error:null,response:null,subRequest:g!=i?g:null};var y=_.error=o._createError(g?g.messageKey:a,f.details,f.fieldErrorsByField);t.push(_);s=o._buildDetails(s,y)}var m={responses:t};var b=o._createError(a,s,null,m);return b};var y={messageKey:a,batchRequests:u,process:d,transformError:_,change:s};return y};i.prototype.executeRequest=function(r,t,o){this._checkInit();var s=this;var n=function(r){if(r.allSuccess){var n=r.responses;e(n.length==1,"aExecuteResponses length should be 1");var i=n[0];var l=i.response;if(t)t(l)}else{var u=function(){if(o)o()};a.showExecuteError(s._oComponent,null,r,true,u)}};this.executeRequests([r],n)};i.prototype.executeRequests=function(r,a){this._checkInit();e(r.length>0,"aRequests should contain at least one element");var o=this;var s=0;this._oModel.clearBatch();for(var n=0;n<r.length;n++){var i=r[n];var l=i.change;var u=i.batchRequests;var v=u.length;e(v>0,"iBatchRequestsLength should be > 0");s+=l?1:v;if(l)this._oModel.addBatchChangeOperations(u);else this._oModel.addBatchReadOperations(u)}var c={allSuccess:true,error:null,responses:[]};var p=function(){var e=c.allSuccess;var r=function(){o._oComponent.getNavigator().releaseBusyDialog()};if(!e)setTimeout(r(),1e3);if(a)a(c);if(e)setTimeout(r(),1e3)};var h=function(e){if(e.__batchResponses.length!=s){c.error=o._createError("ODataManager.error.gateway");c.allSuccess=false;p();return}var a=0;for(var n=0;n<r.length;n++){var i=r[n];var l=i.change;var u=i.batchRequests;var v=u.length;var h=a+(l?1:v);var f=e.__batchResponses.slice(a,h);a=h;var g={error:null,response:null};for(var d=0;d<f.length;d++){var _=f[d];if(_.response){var y=i.transformError;var m=o._parseODataError(i.messageKey,_,y?v:null,y&&!l?d:null);g.error=y?y(m):m;c.allSuccess=false;break}}if(!g.error){if(l&&f[0].__changeResponses.length!=v){c.error=o._createError("ODataManager.error.gateway");c.responses=[];c.allSuccess=false;p();return}try{var b=l?f[0].__changeResponses:f;var E=i.process;var O=E?E(b):null;var R=i.postProcess;g.response=R?R(O):O}catch(e){if(!(e instanceof t))throw e;var M=o._oComponent.getI18nBundle().getText(e.detailKey,e.args);g.error=o._createError(i.messageKey,[M],null,e.data);c.allSuccess=false}}c.responses.push(g)}p()};var f=function(e){c.error=o._parseODataError("ODataManager.error.gateway",e);c.allSuccess=false;p()};this._oComponent.getNavigator().requireBusyDialog();this._oModel.submitBatch(h,f,true)};i.prototype.parseRawResponse=function(e,r,t,a,o){var s=this._parseJSON(r);var n=this;var i=function(){var e=[];if(s&&s.hasOwnProperty("error")&&s.error.hasOwnProperty("message")&&s.error.message.hasOwnProperty("value")){var r=s.error.message.value;e.push(r)}var a=n._createError(t,e);var i=function(){if(o)o()};n._showError(a,i)};if(e<200||e>299||!s){i();return}var l=s.d;if(!l){i();return}if(a)a(l)};i.prototype._requestForDoPostponeError=function(){e(false,"_requestForDoPostponeError should be overridden in derived class")};i.prototype._getServiceURL=function(){e(false,"_getServiceURL should be overridden in derived class")};i.prototype._createBatchOperation=function(e,r,t,a){this._oModel.setHeaders(a);var o=this._oModel.createBatchOperation(e,r,t);this._oModel.setHeaders(null);return o};i.prototype._filterProperties=function(e,r){var t={};for(var a=0;a<r.length;a++){var o=r[a];var s=e[o];if(s!=null)t[o]=s}return t};i.prototype._escapeParamsForKey=function(e){var r=this._escapeParams(e,",",true);return r};i.prototype._escapeParamsForFI=function(e){var r=this._escapeParams(e,"&",true);return r};i.prototype._escapeParamsForGeneric=function(e){var r=this._escapeParams(e,"&",false);return r};i.prototype._escapeParams=function(r,t,o){var s=[];for(var n in r){var i=r[n];var l;switch(jQuery.type(i)){case"boolean":l=i.toString();break;case"string":l=o?"'"+encodeURIComponent(i.replace(/'/g,"''"))+"'":encodeURIComponent(i);break;case"date":l="datetime'"+encodeURIComponent(a.convertDateToString(i,"-")+"T"+a.convertTimeToString(i))+"'";break;default:e(false,"vValue type is unknown")}l=encodeURIComponent(n)+"="+l;s.push(l)}var u=s.join(t);return u};i.prototype._parseJSON=function(e){var r=null;try{r=JSON.parse(e)}catch(e){if(!(e instanceof SyntaxError))throw e}return r};i.prototype._createError=function(r,t,a,o){e(r,"sMessageKey should be set");var s={message:this._oComponent.getI18nBundle().getText(r),details:t?t:[],fieldErrorsByField:a?a:{}};if(o)jQuery.extend(s,o);return s};i.prototype._showError=function(e,r){var t=e.details;a.showMessageBox(this._oComponent,{type:a.MessageBoxType.Error,message:e.message,details:t.length>0?t.join("\n"):null},r)};i.prototype._parseODataError=function(r,t,a,i){var l=a!=null;var u={};var v=[];var c={};if(i!=null)e(l,"bHaveOpLen should be set");var p=function(r){e(l,"bHaveOpLen should be set");var t=n;if(r!=null){var o=parseInt(r);if(!isNaN(o)&&o>=0&&o<a)t=o.toString()}var s=u[t];if(!s){s=u[t]={details:[],fieldErrorsByField:{}}}return s};var h=function(e,r){if(l){var t=p(e);t.details.push(r)}else{v.push(r)}};var f=function(e,r,t){if(l){var a=p(e);var o=a.fieldErrorsByField[r];if(!o)o=a.fieldErrorsByField[r]=[];o.push(t)}else{var s=c[r];if(!s)s=c[r]=[];s.push(t)}};if(!t.getParameters){if(t.response.statusCode==0){var g=this._oComponent.getI18nBundle().getText("ODataManager.error.connection");h(null,g)}else{var d=this._parseJSON(t.response.body);if(d&&d.hasOwnProperty("error")&&d.error.hasOwnProperty("message")&&d.error.message.hasOwnProperty("value")){var _=d.error.message.value;if(_.indexOf(o)!=0){var g=_;h(null,g)}else{var y=d.error.innererror.errordetails;for(var m=0;m<y.length;m++){var b=y[m];var E=b.message;if(b.code==o){var O=b.propertyref.split("/");var R=O.length;var M=i!=null?i.toString():R>=2?O[0]:null;if(R==3&&O[1]==s){var S=O[2];f(M,S,E)}else{h(M,E)}}}}}}}var D=null;if(l){D={errorObjsByOpIndex:u}}var B=this._createError(r,v,c,D);return B};i.prototype._buildDetails=function(e,r){e=e.slice(0);if(e.length>0)e.push("");var t=a.getErrorMessages(r.message,r.details,r.fieldErrorsByField);e=e.concat(t);return e};i.prototype._opIndexSorter=function(r,t){var a=function(r){var t=r==n?-1:parseInt(r);e(!isNaN(t),"iOpIndex should be an integer");return t};var o=a(r);var s=a(t);var i=o-s;return i};i.prototype._checkInit=function(r){var t=this.isInited();if(r)t=!t;e(t,r?"ODataManager is already initialized":"ODataManager is not yet initialized")};return i});